<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>如何进行JVM调优 | 黯淡的晨</title><meta name="author" content="黯淡的晨"><meta name="copyright" content="黯淡的晨"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="从JVM何时需要调优，到JVM调优需要掌握的工具，以及从实际调优案例中进行JVM调优经验总结，从此不再是令人闻之色变的拦路虎。">
<meta property="og:type" content="article">
<meta property="og:title" content="如何进行JVM调优">
<meta property="og:url" content="http://example.com/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/index.html">
<meta property="og:site_name" content="黯淡的晨">
<meta property="og:description" content="从JVM何时需要调优，到JVM调优需要掌握的工具，以及从实际调优案例中进行JVM调优经验总结，从此不再是令人闻之色变的拦路虎。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/%E4%BC%91%E9%97%B2.jpg">
<meta property="article:published_time" content="2023-06-28T03:18:05.000Z">
<meta property="article:modified_time" content="2023-07-02T12:37:54.955Z">
<meta property="article:author" content="黯淡的晨">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/%E4%BC%91%E9%97%B2.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: 黯淡的晨","link":"Link: ","source":"Source: 黯淡的晨","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '如何进行JVM调优',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-02 20:37:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E7%B4%AB%E7%81%B5.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">黯淡的晨</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">如何进行JVM调优</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-06-28T03:18:05.000Z" title="Created 2023-06-28 11:18:05">2023-06-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="如何进行JVM调优"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="1-JVM-何时优化？"><a href="#1-JVM-何时优化？" class="headerlink" title="1. JVM 何时优化？"></a>1. JVM 何时优化？</h2><p>忌过早优化。《计算机程序设计艺术》的作者高德纳（Donald Ervin Knuth）曾说过一句经典的话：</p>
<blockquote>
<p>The real problem is that programmers have spent far too much time worrying about efficiency in the wrong places and at the wrong times；premature optimization is the root of all evil（or at least most of it）in programming.<br>真正的问题是，程序猿在错误的地方和错误的时间花了太多的时间担心效率问题；过早的优化是编程中所有（或者至少是大部分）罪恶的根源。</p>
</blockquote>
<p>忌过早并不是说就完全不管，比较正确的做法应该是给核心服务的一些重要JVM指标配上监控告警，当指标出现波动或者异常时，能及时介入排查。</p>
<p><strong>面试官：JVM有哪些核心指标？合理范围应该是多少？</strong></p>
<p>这个问题没有统一的答案，因为每个服务对AVG&#x2F;TP999&#x2F;TP9999等性能指标的要求是不同的，因此合理的范围也不同。</p>
<p>为了防止面试官追问，对于普通的Java后端应用来说，我这边给出一份相对合理的范围值。以下指标都是对于单台服务器来说：</p>
<ul>
<li>jvm.gc.time：每分钟的GC耗时在1s以内，500ms以内尤佳</li>
<li>jvm.gc.meantime：每次YGC耗时在100ms以内，50ms以内尤佳</li>
<li>jvm.fullgc.count:FGC最多几小时1次，1天不到1次尤佳</li>
<li>jvm.fullgc.time：每次FGC耗时在1s以内，500ms以内尤佳</li>
</ul>
<p>通常来说，只要这几个指标正常，其他的一般不会有问题，如果其他地方出了问题，一般都会影响到这几个指标。</p>
<p>当这几个指标出现异常的时候，我们就需要对JVM进行调优。</p>
<h2 id="2-JVM调优工具"><a href="#2-JVM调优工具" class="headerlink" title="2. JVM调优工具"></a>2. JVM调优工具</h2><h3 id="jps-Java-Virtual-Machine-Process-Status-Tool"><a href="#jps-Java-Virtual-Machine-Process-Status-Tool" class="headerlink" title="jps(Java Virtual Machine Process Status Tool)"></a>jps(Java Virtual Machine Process Status Tool)</h3><p>jps主要用来输出JVM中运行的进程状态信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps [options] [<span class="built_in">hostid</span>]</span><br></pre></td></tr></table></figure>

<h3 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h3><p>主要用来查看某个Java进程内的线程堆栈信息.</p>
<p>jstack可以定位到线程堆栈，根据堆栈信息我们可以定位到具体代码，所以它在JVM性能调优中使用得非常多。下面我们来一个实例找出某个Java进程中最耗费CPU的Java线程并定位堆栈信息，用到的命令有ps、top、printf、jstack、grep。</p>
<p>第一步<strong>先找出Java进程ID</strong>，我部署在服务器上的Java应用名称为mrf-center：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># ps -ef | grep mrf-center | grep -v grep</span></span><br></pre></td></tr></table></figure>

<p>得到结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root     21711     1  1 14:47 pts/3    00:02:10 java -jar mrf-center.jar</span><br></pre></td></tr></table></figure>

<p>得到进程ID为21711，第二步<strong>找出该进程内最耗费CPU的线程</strong>，可以使用<code>ps -Lfp pid</code>或者<code>ps -mp pid -o THREAD</code>, tid, time或者top -Hp pid，我这里用第三个，输出如下：</p>
<p><img src="/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/1.png"></p>
<p>TIME列就是各个Java线程耗费的CPU时间，CPU时间最长的是线程ID为21742的线程，用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%x\n&quot;</span> 21742</span><br></pre></td></tr></table></figure>

<p>得到21742的十六进制值为54ee，下面会用到。</p>
<p>OK，下一步终于轮到jstack上场了，它用来输出进程21711的堆栈信息，然后根据线程ID的十六进制值grep，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># jstack 21711 | grep 54ee</span></span><br></pre></td></tr></table></figure>

<p>输出为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;PollIntervalRetrySchedulerThread&quot;</span> prio=10 tid=0x00007f950043e000 nid=0x54ee <span class="keyword">in</span> Object.<span class="built_in">wait</span>() [0x00007f94c6eda000]</span><br></pre></td></tr></table></figure>

<p>可以看到CPU消耗在PollIntervalRetrySchedulerThread这个类的Object.wait()，定位到代码。</p>
<h3 id="jmap-Memory-Map-和jhat-Java-Heap-Analysis-Tool"><a href="#jmap-Memory-Map-和jhat-Java-Heap-Analysis-Tool" class="headerlink" title="jmap(Memory Map)和jhat(Java Heap Analysis Tool)"></a>jmap(Memory Map)和jhat(Java Heap Analysis Tool)</h3><p>jmap用来查看堆内存使用状况，一般结合jhat使用。</p>
<p>使用<code>jmap -heap pid</code>查看进程堆内存使用情况，包括使用的GC算法、堆配置参数和各代中堆内存使用情况。比如下面的例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># jmap -heap 21711</span></span><br><span class="line">Attaching to process ID 21711, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 20.10-b01</span><br><span class="line"> </span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 4 thread(s)</span><br><span class="line"> </span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio = 40</span><br><span class="line">   MaxHeapFreeRatio = 70</span><br><span class="line">   MaxHeapSize      = 2067791872 (1972.0MB)</span><br><span class="line">   NewSize          = 1310720 (1.25MB)</span><br><span class="line">   MaxNewSize       = 17592186044415 MB</span><br><span class="line">   OldSize          = 5439488 (5.1875MB)</span><br><span class="line">   NewRatio         = 2</span><br><span class="line">   SurvivorRatio    = 8</span><br><span class="line">   PermSize         = 21757952 (20.75MB)</span><br><span class="line">   MaxPermSize      = 85983232 (82.0MB)</span><br><span class="line"> </span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 6422528 (6.125MB)</span><br><span class="line">   used     = 5445552 (5.1932830810546875MB)</span><br><span class="line">   free     = 976976 (0.9317169189453125MB)</span><br><span class="line">   84.78829520089286% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 131072 (0.125MB)</span><br><span class="line">   used     = 98304 (0.09375MB)</span><br><span class="line">   free     = 32768 (0.03125MB)</span><br><span class="line">   75.0% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 131072 (0.125MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 131072 (0.125MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 35258368 (33.625MB)</span><br><span class="line">   used     = 4119544 (3.9287033081054688MB)</span><br><span class="line">   free     = 31138824 (29.69629669189453MB)</span><br><span class="line">   11.683876009235595% used</span><br><span class="line">PS Perm Generation</span><br><span class="line">   capacity = 52428800 (50.0MB)</span><br><span class="line">   used     = 26075168 (24.867218017578125MB)</span><br><span class="line">   free     = 26353632 (25.132781982421875MB)</span><br><span class="line">   49.73443603515625% used</span><br><span class="line">   ....</span><br></pre></td></tr></table></figure>

<p>使用jmap -histo[:live] pid查看堆内存中的对象数目、大小统计直方图，如果带上live则只统计活对象，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># jmap -histo:live 21711 | more</span></span><br><span class="line"> </span><br><span class="line"> num     <span class="comment">#instances         #bytes  class name</span></span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:         38445        5597736  &lt;constMethodKlass&gt;</span><br><span class="line">   2:         38445        5237288  &lt;methodKlass&gt;</span><br><span class="line">   3:          3500        3749504  &lt;constantPoolKlass&gt;</span><br><span class="line">   4:         60858        3242600  &lt;symbolKlass&gt;</span><br><span class="line">   5:          3500        2715264  &lt;instanceKlassKlass&gt;</span><br><span class="line">   6:          2796        2131424  &lt;constantPoolCacheKlass&gt;</span><br><span class="line">   7:          5543        1317400  [I</span><br><span class="line">   8:         13714        1010768  [C</span><br><span class="line">   9:          4752        1003344  [B</span><br><span class="line">  10:          1225         639656  &lt;methodDataKlass&gt;</span><br><span class="line">  11:         14194         454208  java.lang.String</span><br><span class="line">  12:          3809         396136  java.lang.Class</span><br><span class="line">  13:          4979         311952  [S</span><br><span class="line">  14:          5598         287064  [[I</span><br><span class="line">  15:          3028         266464  java.lang.reflect.Method</span><br><span class="line">  16:           280         163520  &lt;objArrayKlassKlass&gt;</span><br><span class="line">  17:          4355         139360  java.util.HashMap<span class="variable">$Entry</span></span><br><span class="line">  18:          1869         138568  [Ljava.util.HashMap<span class="variable">$Entry</span>;</span><br><span class="line">  19:          2443          97720  java.util.LinkedHashMap<span class="variable">$Entry</span></span><br><span class="line">  20:          2072          82880  java.lang.ref.SoftReference</span><br><span class="line">  21:          1807          71528  [Ljava.lang.Object;</span><br><span class="line">  22:          2206          70592  java.lang.ref.WeakReference</span><br><span class="line">  23:           934          52304  java.util.LinkedHashMap</span><br><span class="line">  24:           871          48776  java.beans.MethodDescriptor</span><br><span class="line">  25:          1442          46144  java.util.concurrent.ConcurrentHashMap<span class="variable">$HashEntry</span></span><br><span class="line">  26:           804          38592  java.util.HashMap</span><br><span class="line">  27:           948          37920  java.util.concurrent.ConcurrentHashMap<span class="variable">$Segment</span></span><br><span class="line">  28:          1621          35696  [Ljava.lang.Class;</span><br><span class="line">  29:          1313          34880  [Ljava.lang.String;</span><br><span class="line">  30:          1396          33504  java.util.LinkedList<span class="variable">$Entry</span></span><br><span class="line">  31:           462          33264  java.lang.reflect.Field</span><br><span class="line">  32:          1024          32768  java.util.Hashtable<span class="variable">$Entry</span></span><br><span class="line">  33:           948          31440  [Ljava.util.concurrent.ConcurrentHashMap<span class="variable">$HashEntry</span>;</span><br></pre></td></tr></table></figure>

<p>还有一个很常用的情况是：用jmap把进程内存使用情况dump到文件中，再用jhat分析查看。jmap进行dump命令格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=dumpFileName pid</span><br></pre></td></tr></table></figure>

<p>我一样地对上面进程ID为21711进行Dump：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># jmap -dump:format=b,file=/tmp/dump.dat 21711  </span></span><br><span class="line"></span><br><span class="line">Dumping heap to /tmp/dump.dat ...</span><br><span class="line"></span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>

<p>dump出来的文件可以用MAT、VisualVM等工具查看，这里用jhat查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># jhat -port 9998 /tmp/dump.dat</span></span><br><span class="line">Reading from /tmp/dump.dat...</span><br><span class="line">Dump file created Tue Jan 28 17:46:14 CST 2014</span><br><span class="line">Snapshot <span class="built_in">read</span>, resolving...</span><br><span class="line">Resolving 132207 objects...</span><br><span class="line">Chasing references, expect 26 dots..........................</span><br><span class="line">Eliminating duplicate references..........................</span><br><span class="line">Snapshot resolved.</span><br><span class="line">Started HTTP server on port 9998</span><br><span class="line">Server is ready</span><br></pre></td></tr></table></figure>

<h3 id="jstat（JVM统计监测工具）"><a href="#jstat（JVM统计监测工具）" class="headerlink" title="jstat（JVM统计监测工具）"></a>jstat（JVM统计监测工具）</h3><p>用来监测新生代（伊甸园区，幸存区from，幸存区to）、老年代、永久代的容量和使用量以及GC和FullGC的次数和耗时。</p>
<p>语法格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstat [ generalOption | outputOptions vmid [interval[s|ms] [count]] ]</span><br></pre></td></tr></table></figure>

<p>vmid是Java虚拟机ID，在Linux&#x2F;Unix系统上一般就是进程ID。interval是采样时间间隔。count是采样数目。比如下面输出的是GC信息，采样时间间隔为250ms，采样数为4：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/<span class="comment"># jstat -gc 21711 250 4</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT  </span><br><span class="line">192.0  192.0   64.0   0.0    6144.0   1854.9   32000.0     4111.6   55296.0 25472.7    702    0.431   3      0.218    0.649</span><br><span class="line">192.0  192.0   64.0   0.0    6144.0   1972.2   32000.0     4111.6   55296.0 25472.7    702    0.431   3      0.218    0.649</span><br><span class="line">192.0  192.0   64.0   0.0    6144.0   1972.2   32000.0     4111.6   55296.0 25472.7    702    0.431   3      0.218    0.649</span><br><span class="line">192.0  192.0   64.0   0.0    6144.0   2109.7   32000.0     4111.6   55296.0 25472.7    702    0.431   3      0.218    0.649</span><br></pre></td></tr></table></figure>

<blockquote>
<p>S0C、S1C、S0U、S1U：Survivor 0&#x2F;1区容量（Capacity）和使用量（Used）<br>EC、EU：Eden区容量和使用量<br>OC、OU：年老代容量和使用量<br>PC、PU：永久代容量和使用量<br>YGC、YGT：年轻代GC次数和GC耗时<br>FGC、FGCT：Full GC次数和Full GC耗时<br>GCT：GC总耗时</p>
</blockquote>
<h3 id="jconsole、jvisualvm"><a href="#jconsole、jvisualvm" class="headerlink" title="jconsole、jvisualvm"></a>jconsole、jvisualvm</h3><p>利用jconsole、jvisualvm分析内存信息(各个区如Eden、Survivor、Old等内存变化情况）</p>
<p>下图是jconsole界面，概览选项可以观测堆内存使用量、线程数、类加载数和CPU占用率；内存选项可以查看堆中各个区域的内存使用量和左下角的详细描述（内存大小、GC情况等）；线程选项可以查看当前JVM加载的线程，查看每个线程的堆栈信息，还可以检测死锁；VM概要描述了虚拟机的各种详细参数。（jconsole功能演示）<br><img src="/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/2.png"></p>
<p>下图是jvisualvm的界面，功能比jconsole略丰富一些，不过大部分功能都需要安装插件。概述跟jconsole的VM概要差不多，描述的是jvm的详细参数和程序启动参数；监视展示的和jconsole的概览界面差不多（CPU、堆&#x2F;方法区、类加载、线程）；线程和jconsole的线程界面差不多；抽样器可以展示当前占用内存的类的排行榜及其实例的个数；Visual GC可以更丰富地展示当前各个区域的内存占用大小及历史信息（下图）(jvisualvm功能演示）<br>工具路径：<code>//java/jdk1.8xxx/bin/JVisuaVM.exe</code></p>
<blockquote>
<p>监控本地的Tomcat<br>监控远程Tomcat<br>监控普通的JAVA进程</p>
</blockquote>
<p><img src="/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/3.png"></p>
<h2 id="3-JVM调优经验总结"><a href="#3-JVM调优经验总结" class="headerlink" title="3. JVM调优经验总结"></a>3. JVM调优经验总结</h2><h3 id="3-1-调优的最终目标是什么"><a href="#3-1-调优的最终目标是什么" class="headerlink" title="3.1.调优的最终目标是什么"></a>3.1.调优的最终目标是什么</h3><ol>
<li>GC的时间足够的小</li>
<li>GC的次数足够的少</li>
<li>发生Full GC的周期足够的长</li>
</ol>
<p>前两个目前是相悖的，要想GC时间小必须要一个更小的堆，要保证GC次数足够少，必须保证一个更大的堆，我们只能取其平衡。</p>
<p>更大的年轻代必然导致更小的年老代，大的年轻代会延长普通GC的周期，但会增加每次GC的时间；小的年老代会导致更频繁的Full GC<br>更小的年轻代必然导致更大年老代，小的年轻代会导致普通GC很频繁，但每次的GC时间会更短；大的年老代会减少Full GC的频率</p>
<p>如何选择应该依赖应用程序对象生命周期的分布情况：<strong>如果应用存在大量的临时对象，应该选择更大的年轻代；如果存在相对较多的持久对象，年老代应该适当增大。</strong></p>
<p>但很多应用都没有这样明显的特性，在抉择时应该根据以下两点：</p>
<ul>
<li>本着Full GC尽量少的原则，让<strong>年老代尽量缓存常用对象</strong>，JVM的默认比例3:8也是这个道理</li>
<li>通过观察应用一段时间，看其他在峰值时年老代会占多少内存，在不影响FullGC的前提下，<strong>根据实际情况加大年轻代</strong>，比如可以把比例控制在1:1。但应该给年老代至少预留1&#x2F;3的增长空间</li>
</ul>
<h3 id="3-2-将新对象预留在年轻代"><a href="#3-2-将新对象预留在年轻代" class="headerlink" title="3.2.将新对象预留在年轻代"></a>3.2.将新对象预留在年轻代</h3><p>众所周知，由于 Full GC 的成本远远高于 Minor GC，因此某些情况下需要<strong>尽可能将对象分配在年轻代</strong>，这在很多情况下是一个明智的选择。虽然在大部分情况下，JVM 会尝试在 Eden 区分配对象，但是由于空间紧张等问题，很可能不得不将部分年轻对象提前向年老代压缩。因此，<strong>在 JVM 参数调优时可以为应用程序分配一个合理的年轻代空间，以最大限度避免新对象直接进入年老代的情况发生</strong>。</p>
<p>通过设置一个较大的年轻代预留新对象，<strong>设置合理的 Survivor 区并且提供 Survivor 区的使用率，可以将年轻对象保存在年轻代</strong>。一般来说，Survivor 区的空间不够，或者占用量达到 50%时，就会使对象进入年老代(不管它的年龄有多大)</p>
<p>我们可以尝试加上参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:TargetSurvivorRatio=90</span><br></pre></td></tr></table></figure>

<p>这样可以<strong>提高 from 区的利用率</strong>，使 from 区使用到 <strong>90%时</strong>，再<strong>将对象送入年老代</strong></p>
<h3 id="3-3-让大对象进入年老代"><a href="#3-3-让大对象进入年老代" class="headerlink" title="3.3.让大对象进入年老代"></a>3.3.让大对象进入年老代</h3><p>我们在大部分情况下都会选择将对象分配在年轻代。但是，对于占用内存较多的大对象而言，它的选择可能就不是这样的。因为大对象出现在年轻代很可能扰乱年轻代 GC，并破坏年轻代原有的对象结构。因为尝试在年轻代分配大对象，很可能导致空间不足，为了有足够的空间容纳大对象，JVM 不得不将年轻代中的年轻对象挪到年老代。因为大对象占用空间多，所以可能需要移动大量小的年轻对象进入年老代，这对 GC 相当不利。</p>
<p>基于以上原因，可以将大对象直接分配到年老代，保持年轻代对象结构的完整性，这样可以提高 GC 的效率。如果一个大对象同时又是一个短命的对象，假设这种情况出现很频繁，那对于 GC 来说会是一场灾难。原本应该用于存放永久对象的年老代，被短命的对象塞满，这也意味着对堆空间进行了洗牌，扰乱了分代内存回收的基本思路。因此，在软件开发过程中，应该尽可能避免使用短命的大对象。</p>
<p>可以使用参数：<code>-XX:PetenureSizeThreshold</code></p>
<p>设置大对象直接进入年老代的阈值。当对象的大小超过这个值时，将直接在年老代分配。</p>
<p>参数<code>-XX:PetenureSizeThreshold</code> 只对串行收集器和年轻代并行收集器有效，并行回收收集器不识别这个参数。</p>
<h3 id="3-4-设置对象进入年老代的年龄"><a href="#3-4-设置对象进入年老代的年龄" class="headerlink" title="3.4. 设置对象进入年老代的年龄"></a>3.4. 设置对象进入年老代的年龄</h3><p>如何设置对象进入年老代的年龄</p>
<blockquote>
<p>堆中的每一个对象都有自己的年龄。一般情况下，年轻对象存放在年轻代，年老对象存放在年老代。为了做到这点，虚拟机为每个对象都维护一个年龄。如果对象在 Eden 区，经过一次 GC 后依然存活，则被移动到 Survivor 区中，对象年龄加 1。以后，如果对象每经过一次 GC 依然存活，则年龄再加 1。当对象年龄达到阈值时，就移入年老代，成为老年对象。</p>
</blockquote>
<p>这个阈值的最大值可以通过参数<code>-XX:MaxTenuringThreshold</code>来设置（晋升阈值）</p>
<p>默认值是 15。虽然-XX:MaxTenuringThreshold 的值可能是 15 或者更大，但这不意味着新对象非要达到这个年龄才能进入年老代。事实上，对象实际进入年老代的年龄是虚拟机在运行时根据内存使用情况动态计算的，这个参数指定的是阈值年龄的最大值。即，实际晋升年老代年龄等于动态计算所得的年龄与-XX:MaxTenuringThreshold 中较小的那个。</p>
<h3 id="3-5-稳定的-Java-堆-VS-动荡的-Java-堆"><a href="#3-5-稳定的-Java-堆-VS-动荡的-Java-堆" class="headerlink" title="3.5.稳定的 Java 堆 VS 动荡的 Java 堆"></a>3.5.稳定的 Java 堆 VS 动荡的 Java 堆</h3><p>一般来说，稳定的堆大小对垃圾回收是有利的。<strong>获得一个稳定的堆大小的方法是使-Xms 和-Xmx 的大小一致，即最大堆和最小堆 (初始堆)一样</strong>。</p>
<p>如果这样设置，系统在运行时堆大小理论上是恒定的，<strong>稳定的堆空间可以减少 GC 的次数</strong>。因此，很多服务端应用都会将最大堆和最小堆设置为相同的数值。但是，一个不稳定的堆并非毫无用处。稳定的堆大小虽然可以减少 GC 次数，但同时也增加了每次GC的时间。让堆大小在一个区间中震荡，在系统不需要使用大内存时，压缩堆空间，使 GC 应对一个较小的堆，可以加快单次 GC 的速度。基于这样的考虑，JVM 还提供了两个参数用于<strong>压缩和扩展堆空间</strong>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:MinHeapFreeRatio</span><br></pre></td></tr></table></figure>

<p>参数用来设置堆空间最小空闲比例，默认值是 40。当堆空间的空闲内存小于这个数值时，JVM 便会扩展堆空间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:MaxHeapFreeRatio</span><br></pre></td></tr></table></figure>

<p>参数用来设置堆空间最大空闲比例，默认值是 70。当堆空间的空闲内存大于这个数值时，便会压缩堆空间，得到一个较小的堆。</p>
<p>当**-Xmx 和-Xms 相等<strong>时，</strong>-XX:MinHeapFreeRatio 和-XX:MaxHeapFreeRatio 两个参数无效**。</p>
<h3 id="3-6-增大吞吐量提升系统性能"><a href="#3-6-增大吞吐量提升系统性能" class="headerlink" title="3.6.增大吞吐量提升系统性能"></a>3.6.增大吞吐量提升系统性能</h3><p>吞吐量优先的方案将会尽可能减少系统执行垃圾回收的总时间，故可以考虑关注系统吞吐量的并行回收收集器。在拥有高性能的计算机上，进行吞吐量优先优化，可以使用参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java –Xmx3800m –Xms3800m –Xmn2G –Xss128k –XX:+UseParallelGC </span><br><span class="line">   –XX:ParallelGC-Threads=20 –XX:+UseParallelOldGC</span><br></pre></td></tr></table></figure>

<h2 id="4-一些JVM参数"><a href="#4-一些JVM参数" class="headerlink" title="4. 一些JVM参数"></a>4. 一些JVM参数</h2><h3 id="4-1-设定堆内存大小"><a href="#4-1-设定堆内存大小" class="headerlink" title="4.1.设定堆内存大小"></a>4.1.设定堆内存大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Xms：启动JVM时的堆内存空间。</span><br><span class="line">-Xmx：堆内存最大限制。</span><br><span class="line">-Xmn：设置年轻代大小整个堆大小=年轻代大小 + 年老代大小 + 持久代大小，Sun官方推荐配置为整个堆的3/8</span><br><span class="line">-XX:PermSize=128M设置持久代大小</span><br><span class="line">-XX:MaxPermSize=128M设置持久代最大值，此值可以设置与-XX:PermSize相同，防止持久代内存伸缩，持久代设置很重要，一般预留其使用空间的1/3.</span><br></pre></td></tr></table></figure>

<h3 id="4-2-设定新生代大小"><a href="#4-2-设定新生代大小" class="headerlink" title="4.2.设定新生代大小"></a>4.2.设定新生代大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:NewRatio：新生代和老年代的占比。</span><br><span class="line">-XX:NewSize：新生代空间。</span><br><span class="line">-XX:SurvivorRatio：伊甸园空间和幸存者空间的占比。</span><br><span class="line">-XX:MaxTenuringThreshold：对象进入老年代的年龄阈值。</span><br></pre></td></tr></table></figure>

<h3 id="4-3-设定垃圾回收器"><a href="#4-3-设定垃圾回收器" class="headerlink" title="4.3.设定垃圾回收器"></a>4.3.设定垃圾回收器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseSerialGC 开启串行收集器</span><br><span class="line">-XX:+UseParallelGC开启年轻代并行收集器，JDK5.0以上，JVM会根据系统配置自行设置，所以无需再设置此值</span><br><span class="line">-XX:+UseParallelOldGC开启老年代并行收集器</span><br><span class="line">-XX:+UseConcMarkSweepGC开启老年代并发收集器(简称CMS)，可以和UseParallelGC一起使用</span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=70老年代内存使用比例到多少激活CMS收集器，这个数值的设置有很大技巧基本上满足(Xmx-Xmn)*(100-CMSInitiatingOccupancyFraction)/100&gt;=Xmn否则会出现“Concurrent Mode Failure”，promotionfailed，官方建议数值为68</span><br><span class="line">-XX:+UseCMSCompactAtFullCollection：使用并发收集器时，开启对年老代的压缩</span><br></pre></td></tr></table></figure>

<h3 id="4-4-其他"><a href="#4-4-其他" class="headerlink" title="4.4.其他"></a>4.4.其他</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-Xss： 设置每个线程的堆栈大小，设置每个线程的堆栈大小。JDK5.0以后每个线程堆栈大小为1M，以前每个线程堆栈大小为256K。更具应用的线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右，这个参数对性能的影响比较大的</span><br><span class="line">-XX:MaxTenuringThreshold=0：设置垃圾最大年龄。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论，linux64的java6默认值是15</span><br><span class="line">-XX:ParallelGCThreads=设置并行垃圾回收的线程数。此值可以设置与机器处理器数量相等（逻辑cpu数），这个不确定是物理、还是逻辑使用默认就好</span><br><span class="line">-XX:MaxGCPauseMillis=指定垃圾回收时的最长暂停时间，单位毫秒，如果指定了此值的话，堆大小和垃圾回收相关参数会进行调整以达到指定值，设定此值可能会减少应用的吞吐量</span><br><span class="line">-XX:GCTimeRatio=设定吞吐量为垃圾回收时间与非垃圾回收时间的比值，公式为1/（1+N）。例如，-XX:GCTimeRatio=19时，表示5%的时间用于垃圾回收。默认情况为99，即1%的时间用于垃圾回收</span><br><span class="line">-XX:+UseAdaptiveSizePolicy：设置此选项后，并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时，一直打开</span><br><span class="line">-XX:+DisableExplicitGC：禁止 java 程序中的 full gc, 如System.gc() 的调用. 最好加上， 防止程序在代码里误用了对性能造成冲击</span><br><span class="line">-XX:+PrintGCDetails 打应垃圾收集的情况</span><br><span class="line">-XX:+PrintGCTimeStamps 打应垃圾收集的情况</span><br><span class="line">-XX:+PrintGCApplicationConcurrentTime：打印每次垃圾回收前，程序未中断的执行时间。可与上面混合使用</span><br><span class="line">-XX:+PrintGCApplicationStoppedTime 打应垃圾收集时 , 系统的停顿时间</span><br><span class="line">-XX:+PrintGC 打印GC情况</span><br><span class="line">-XX:PrintHeapAtGC:打印GC前后的详细堆栈信息</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">黯淡的晨</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/">http://example.com/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/%E4%BC%91%E9%97%B2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/06/14/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3RocketMq/"><img class="next-cover" src="/img/%E6%98%9F%E7%A9%BA.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">一篇文章深入了解RocketMq消息队列</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/01/05/Java8%E8%AF%AD%E6%B3%95%E7%B3%96/" title="Java8语法糖"><img class="cover" src="/img/%E6%98%9F%E7%A9%BA.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-05</div><div class="title">Java8语法糖</div></div></a></div><div><a href="/2022/12/20/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF/" title="代码模板"><img class="cover" src="/img/%E4%BC%91%E9%97%B2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-20</div><div class="title">代码模板</div></div></a></div><div><a href="/2023/01/05/%E5%BA%8F%E5%88%97%E5%8C%96/" title="序列化"><img class="cover" src="/img/%E6%98%9F%E7%A9%BA.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-05</div><div class="title">序列化</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/%E7%B4%AB%E7%81%B5.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">黯淡的晨</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/fzchen001" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:fzchen1999@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-JVM-%E4%BD%95%E6%97%B6%E4%BC%98%E5%8C%96%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">1. JVM 何时优化？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-JVM%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7"><span class="toc-number">2.</span> <span class="toc-text">2. JVM调优工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jps-Java-Virtual-Machine-Process-Status-Tool"><span class="toc-number">2.1.</span> <span class="toc-text">jps(Java Virtual Machine Process Status Tool)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jstack"><span class="toc-number">2.2.</span> <span class="toc-text">jstack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jmap-Memory-Map-%E5%92%8Cjhat-Java-Heap-Analysis-Tool"><span class="toc-number">2.3.</span> <span class="toc-text">jmap(Memory Map)和jhat(Java Heap Analysis Tool)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jstat%EF%BC%88JVM%E7%BB%9F%E8%AE%A1%E7%9B%91%E6%B5%8B%E5%B7%A5%E5%85%B7%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">jstat（JVM统计监测工具）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jconsole%E3%80%81jvisualvm"><span class="toc-number">2.5.</span> <span class="toc-text">jconsole、jvisualvm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-JVM%E8%B0%83%E4%BC%98%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">3. JVM调优经验总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%B0%83%E4%BC%98%E7%9A%84%E6%9C%80%E7%BB%88%E7%9B%AE%E6%A0%87%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.1.</span> <span class="toc-text">3.1.调优的最终目标是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%B0%86%E6%96%B0%E5%AF%B9%E8%B1%A1%E9%A2%84%E7%95%99%E5%9C%A8%E5%B9%B4%E8%BD%BB%E4%BB%A3"><span class="toc-number">3.2.</span> <span class="toc-text">3.2.将新对象预留在年轻代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%AE%A9%E5%A4%A7%E5%AF%B9%E8%B1%A1%E8%BF%9B%E5%85%A5%E5%B9%B4%E8%80%81%E4%BB%A3"><span class="toc-number">3.3.</span> <span class="toc-text">3.3.让大对象进入年老代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E8%AE%BE%E7%BD%AE%E5%AF%B9%E8%B1%A1%E8%BF%9B%E5%85%A5%E5%B9%B4%E8%80%81%E4%BB%A3%E7%9A%84%E5%B9%B4%E9%BE%84"><span class="toc-number">3.4.</span> <span class="toc-text">3.4. 设置对象进入年老代的年龄</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E7%A8%B3%E5%AE%9A%E7%9A%84-Java-%E5%A0%86-VS-%E5%8A%A8%E8%8D%A1%E7%9A%84-Java-%E5%A0%86"><span class="toc-number">3.5.</span> <span class="toc-text">3.5.稳定的 Java 堆 VS 动荡的 Java 堆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E5%A2%9E%E5%A4%A7%E5%90%9E%E5%90%90%E9%87%8F%E6%8F%90%E5%8D%87%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD"><span class="toc-number">3.6.</span> <span class="toc-text">3.6.增大吞吐量提升系统性能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%B8%80%E4%BA%9BJVM%E5%8F%82%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">4. 一些JVM参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E8%AE%BE%E5%AE%9A%E5%A0%86%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="toc-number">4.1.</span> <span class="toc-text">4.1.设定堆内存大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%AE%BE%E5%AE%9A%E6%96%B0%E7%94%9F%E4%BB%A3%E5%A4%A7%E5%B0%8F"><span class="toc-number">4.2.</span> <span class="toc-text">4.2.设定新生代大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%AE%BE%E5%AE%9A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">4.3.</span> <span class="toc-text">4.3.设定垃圾回收器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%85%B6%E4%BB%96"><span class="toc-number">4.4.</span> <span class="toc-text">4.4.其他</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/" title="如何进行JVM调优">如何进行JVM调优</a><time datetime="2023-06-28T03:18:05.000Z" title="Created 2023-06-28 11:18:05">2023-06-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/14/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3RocketMq/" title="一篇文章深入了解RocketMq消息队列">一篇文章深入了解RocketMq消息队列</a><time datetime="2023-06-14T04:15:41.000Z" title="Created 2023-06-14 12:15:41">2023-06-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/09/SQL%E8%AF%AD%E5%8F%A5%E7%BB%83%E4%B9%A0/" title="SQL语句练习">SQL语句练习</a><time datetime="2023-06-09T05:33:31.000Z" title="Created 2023-06-09 13:33:31">2023-06-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/29/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="MySQL学习笔记">MySQL学习笔记</a><time datetime="2023-05-29T05:17:19.000Z" title="Created 2023-05-29 13:17:19">2023-05-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/27/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="动态规划">动态规划</a><time datetime="2023-03-27T06:47:41.000Z" title="Created 2023-03-27 14:47:41">2023-03-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 黯淡的晨</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://fzchen001.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://example.com/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/'
    this.page.identifier = '/2023/06/28/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJVM%E8%B0%83%E4%BC%98/'
    this.page.title = '如何进行JVM调优'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>